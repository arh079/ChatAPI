using ChatAPI.Data;
using ChatAPI.DTO;
using ChatAPI.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace ChatAPI.Services
{
    public class ChatService : IChatService
    {
        private readonly UserManager<ApplicationUser> userManager;
        private readonly AppDbContext context;
        private readonly IAIService aiService;
        public ChatService(AppDbContext _context, IAIService _aiService, UserManager<ApplicationUser> userManager)
        {
            context = _context;
            aiService = _aiService;
            this.userManager = userManager;
        }

        public async Task<string> SendMessageAsync(string userId, Guid conversationId, string message)
        {

            var conversation =
                await context.Conversations
                .Include(c => c.Messages)
                .FirstOrDefaultAsync(c => c.Id == conversationId && c.UserId == userId);
            if (conversation == null)
            {
                throw new Exception("Conversation not found");
            }

            //Save User Message
            var userMessage = new Message
            {
                Id = Guid.NewGuid(),
                ConversationId = conversationId,
                Role = "user",
                Content = message,
                CreatedAt = DateTime.UtcNow
                
            };

            context.Messages.Add(userMessage);
            await context.SaveChangesAsync();

            //Get Last 10 Messages
            var history =
                context.Messages
                .Where(m => m.ConversationId == conversationId)
                .OrderByDescending(m => m.CreatedAt)
                .Take(10)
                .OrderBy(m => m.CreatedAt)
                .Select(m => new AIMessageDto
                {
                    Role = m.Role,
                    Content = m.Content
                }).ToList();

            var user = await userManager.FindByIdAsync(userId);
            //Add the Last One to History
            history.Add(new AIMessageDto
            {
                Role = "user",
                Content = message 
            });

            var aiReply = await aiService.GetResponseAsync(history);
            

            var botMessage = new Message { 
                Id = Guid.NewGuid(), 
                ConversationId = (Guid)conversationId, 
                Role = "assistant", 
                Content = aiReply, 
                CreatedAt = DateTime.UtcNow
            }; 

            context.Messages.Add(botMessage); 

            conversation.LastUpdatedAt = DateTime.UtcNow; 

            await context.SaveChangesAsync();

            return (aiReply);
        } 


        public async Task<List<MessageDto>> GetHistoryAsync(string userId, Guid conversationId)
        {
            return await context.Messages
                .Where(m => m.ConversationId == conversationId && m.Conversation.UserId == userId)
                .OrderBy(m => m.CreatedAt)
                .Select(m => new MessageDto { Role = m.Role, Content = m.Content })
                .ToListAsync();
        }

        public async Task<Guid> GetOrCreateConversation(string userId)
        {
            var conversation = await context.Conversations.FirstOrDefaultAsync(c => c.UserId == userId); 
            if (conversation != null) 
                return conversation.Id; 

            var newConversation = new Conversation 
            { Id = Guid.NewGuid(),
              UserId = userId, 
              CreatedAt = DateTime.UtcNow,
              LastUpdatedAt = DateTime.UtcNow
            };
            context.Conversations.Add(newConversation); 
            await context.SaveChangesAsync(); 
            return newConversation.Id;
        }
    }
}
